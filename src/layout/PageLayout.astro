---
import Header from "@/components/ui/Header.astro";
import Footer from "@/components/ui/Footer.astro";
import BaseLayout, { type Props as BaseProps } from "./BaseLayout.astro";
import Navigation from "@/components/ui/Navigation.astro";

export interface Props extends BaseProps {
	class?: string;
	bodyClass?: string;
}

const { class: className, bodyClass, ...props } = Astro.props;

import Game from "@/components/pages/Game.astro";
---

<BaseLayout class:list={["", bodyClass]} {...props}>
	<div class="w-full relative z-1">
		<main
			class:list={[
				"flex flex-col px-2",
				"mx-auto w-full md:max-w-4xl lg:max-w-5xl",
			]}
		>
			<Header class="flex-none p-4" transition:name="header" />

			<Navigation />

			<section
				class:list={[
					"flex-auto  px-4 py-8",
					"flex flex-col gap-6 md:gap-8 lg:gap-10",
					className,
				]}
			>
				<slot />
			</section>

			<Footer class="flex-none p-4" transition:name="footer" />
		</main>
	</div>

	<Game />
</BaseLayout>

<script>
	import type { TransitionBeforePreparationEvent } from "astro:transitions/client";

	document.addEventListener(
		"astro:before-preparation",
		(e: TransitionBeforePreparationEvent) => {
			if (!e.sourceElement) return;

			const rect = e.sourceElement.getBoundingClientRect();
			const x = rect.left + rect.width / 2;
			const y = rect.top + rect.height / 2;

			sessionStorage.setItem("click-x", x.toString());
			sessionStorage.setItem("click-y", y.toString());
		},
	);

	document.addEventListener("astro:after-swap", () => {
		const x = sessionStorage.getItem("click-x") || window.innerWidth / 2;
		const y = sessionStorage.getItem("click-y") || window.innerHeight / 2;

		document.documentElement.style.setProperty("--click-x", `${x}px`);
		document.documentElement.style.setProperty("--click-y", `${y}px`);
	});
</script>

<style>
	html {
		position: relative;
		height: auto;
	}
	html::before {
		content: "";
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSBiYXNlRnJlcXVlbmN5PSIwLjkiIG51bU9jdGF2ZXM9IjQiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI25vaXNlKSIgb3BhY2l0eT0iMC40Ii8+PC9zdmc+");
		background-repeat: repeat;
		background-size: var(--noise-size, 256px) var(--noise-size, 256px);
		pointer-events: none;
		z-index: -1;
		opacity: 0.75;
	}
	@media (max-width: 640px) {
		html::before {
			--noise-size: 112px;
		}
	}
	@media (max-width: 420px) {
		html::before {
			--noise-size: 88px;
		}
	}
	@media (max-width: 360px) {
		html::before {
			--noise-size: 72px;
		}
	}
</style>

<style is:global>
	:root {
		--click-x: 50%;
		--click-y: 50%;
	}

	::view-transition-old(root) {
		animation: none;
	}

	::view-transition-new(root) {
		animation: hole 500ms ease-in;
	}

	@keyframes hole {
		from {
			clip-path: circle(0% at var(--click-x, 50%) var(--click-y, 50%));
		}

		to {
			clip-path: circle(100% at var(--click-x, 50%) var(--click-y, 50%));
		}
	}
</style>
